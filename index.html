<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LVG Kino - Улучшенный</title>
<style>
  body {
    font-family: 'Roboto', Arial, sans-serif;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
    color: #ecf0f1;
    overflow-x: hidden;
  }
  h1, h2, h3 {
    text-align: center;
    margin: 10px 0;
  }
  h1 { color: #e74c3c; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);}
  h2, h3 { color: #ecf0f1;}
  
  /* Список сеансов по датам */
  #sessions-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 10px;
  }
  .date-group {
    background: rgba(44, 62, 80, 0.9);
    margin-bottom: 30px;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  .date-group h2 {
    margin-bottom: 15px;
  }
  ul.session-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-start;
  }
  ul.session-list li {
    background-color: #3498db;
    padding: 12px 22px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    user-select: none;
  }
  ul.session-list li:hover {
    background-color: #2980b9;
    transform: scale(1.05);
  }
  ul.session-list li.selected {
    background-color: #e74c3c;
    transform: scale(1.1);
  }

  /* Контейнер с местами и кнопкой */
  #seats-container {
    max-width: 600px;
    margin: 0 auto 40px;
    background: rgba(44, 62, 80, 0.9);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display: none;
  }
  .screen {
    width: 80%;
    height: 20px;
    margin: 0 auto 20px;
    background: #ecf0f1;
    border-radius: 5px;
    text-align: center;
    line-height: 20px;
    color: #2c3e50;
    font-weight: bold;
    user-select: none;
  }
  #seats {
    display: grid;
    grid-template-columns: repeat(8, 50px);
    gap: 12px;
    justify-content: center;
  }
  .seat {
    background-color: #2ecc71;
    color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .seat.booked {
    background-color: #c0392b;
    cursor: not-allowed;
    opacity: 0.7;
  }
  .seat.selected {
    background-color: #f1c40f;
    color: #333;
    transform: scale(1.1);
  }
  .seat:hover:not(.booked):not(.selected) {
    background-color: #27ae60;
  }

  button#book-btn {
    margin-top: 20px;
    width: 100%;
    padding: 14px 0;
    font-size: 1.2em;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    background-color: #e74c3c;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  button#book-btn:hover {
    background-color: #c0392b;
    transform: scale(1.05);
  }

  /* Модальное окно */
  #modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #modal {
    background: #34495e;
    padding: 25px 30px;
    border-radius: 15px;
    color: white;
    max-width: 320px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    text-align: center;
  }
  #modal h3 {
    margin-bottom: 20px;
  }
  #modal label {
    display: block;
    margin-bottom: 10px;
    font-size: 1.1em;
  }
  #modal select {
    width: 100%;
    padding: 8px 10px;
    font-size: 1.1em;
    border-radius: 8px;
    border: none;
    margin-bottom: 20px;
  }
  #modal button {
    background-color: #e74c3c;
    border: none;
    padding: 12px 0;
    width: 100%;
    font-size: 1.1em;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    transition: background-color 0.3s ease;
  }
  #modal button:hover {
    background-color: #c0392b;
  }

  /* Блок оплаты */
  #payment-block {
    margin-top: 20px;
    background: #27ae60;
    padding: 12px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 1.1em;
    color: #fff;
    display: none;
  }

  /* Адаптив */
  @media (max-width: 600px) {
    #seats {
      grid-template-columns: repeat(4, 50px);
      gap: 10px;
    }
    ul.session-list {
      justify-content: center;
    }
    ul.session-list li {
      width: 90%;
      text-align: center;
    }
  }
</style>
</head>
<body>
  <h1>LVG Kino</h1>

  <div id="sessions-container">
    <!-- Сеансы будут сгруппированы по дате -->
  </div>

  <div id="seats-container">
    <h3>Выберите места</h3>
    <div class="screen">Экран</div>
    <div id="seats"></div>
    <button id="book-btn">Забронировать</button>
    <div id="payment-block"></div>
  </div>

  <!-- Модальное окно выбора количества людей -->
  <div id="modal-overlay">
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h3 id="modal-title">Выберите количество человек</h3>
      <label for="people-count">Количество:</label>
      <select id="people-count" aria-describedby="payment-block">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <button id="modal-confirm-btn">Подтвердить</button>
    </div>
  </div>

<script>
  const PRICE_PER_SEAT = 350; // Пример цены за место

  let activeSessions = [];
  let activeSessionIndex = -1;
  let selectedSeats = [];
  let seatsSelectedForBooking = []; // Места, выбранные для бронирования после выбора кол-ва человек
  let peopleCount = 1;

  const sessionsContainer = document.getElementById('sessions-container');
  const seatsContainer = document.getElementById('seats-container');
  const seatsDiv = document.getElementById('seats');
  const bookBtn = document.getElementById('book-btn');
  const paymentBlock = document.getElementById('payment-block');

  const modalOverlay = document.getElementById('modal-overlay');
  const peopleCountSelect = document.getElementById('people-count');
  const modalConfirmBtn = document.getElementById('modal-confirm-btn');

  // --- Загрузка сеансов ---
  async function fetchSessions() {
    try {
      const response = await fetch('https://lvgkino.ru/.netlify/functions/sessions');
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      if (!Array.isArray(data)) {
        alert('Ошибка загрузки сеансов. Попробуйте позже.');
        return [];
      }
      return data;
    } catch (e) {
      alert('Не удалось загрузить сеансы. Проверьте соединение.');
      return [];
    }
  }

  // --- Загрузка бронирований ---
  async function fetchBookings(movie, date, time) {
    try {
      const response = await fetch(`https://lvgkino.ru/.netlify/functions/bookings?movie=${encodeURIComponent(movie)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const bookings = await response.json();
      return bookings;
    } catch (e) {
      alert('Не удалось загрузить данные о бронированиях.');
      return [];
    }
  }

  // --- Проверка прошедших сеансов ---
  function isSessionExpired(session) {
    const now = new Date();
    const sessionTime = new Date(`${session.date}T${session.time}:00`);
    sessionTime.setHours(sessionTime.getHours() + 4); // 4 часа длительность
    return now > sessionTime;
  }

  // --- Группировка сеансов по дате ---
  function groupSessionsByDate(sessions) {
    return sessions.reduce((acc, session) => {
      if (!acc[session.date]) acc[session.date] = [];
      acc[session.date].push(session);
      return acc;
    }, {});
  }

  // --- Сортировка сеансов для админки ---
  // Сначала сеансы с бронированиями, потом остальные, исключая просроченные
  async function sortSessions(sessions) {
    let sessionsWithBookings = [];
    let sessionsWithoutBookings = [];

    for (const session of sessions) {
      if (isSessionExpired(session)) continue; // исключаем просроченные

      const bookings = await fetchBookings(session.movie, session.date, session.time);
      if (bookings.length > 0) sessionsWithBookings.push(session);
      else sessionsWithoutBookings.push(session);
    }

    // Можно дополнительно отсортировать по дате и времени
    function sortByDateTime(a, b) {
      if (a.date < b.date) return -1;
      if (a.date > b.date) return 1;
      if (a.time < b.time) return -1;
      if (a.time > b.time) return 1;
      return 0;
    }

    sessionsWithBookings.sort(sortByDateTime);
    sessionsWithoutBookings.sort(sortByDateTime);

    return [...sessionsWithBookings, ...sessionsWithoutBookings];
  }

  // --- Отрисовка сеансов ---
  async function drawSessions() {
    sessionsContainer.innerHTML = '';
    if (activeSessions.length === 0) {
      sessionsContainer.innerHTML = '<p style="text-align:center;">Нет доступных сеансов</p>';
      return;
    }

    // Группируем по дате
    const grouped = groupSessionsByDate(activeSessions);

    // Для каждой даты создаём блок
    for (const date of Object.keys(grouped).sort()) {
      const dateGroup = document.createElement('div');
      dateGroup.classList.add('date-group');

      const dateTitle = document.createElement('h2');
      dateTitle.textContent = `Дата: ${date}`;
      dateGroup.appendChild(dateTitle);

      const ul = document.createElement('ul');
      ul.classList.add('session-list');

      for (const [idx, session] of grouped[date].entries()) {
        // Получаем бронирования для подсчёта свободных мест
        const bookings = await fetchBookings(session.movie, session.date, session.time);
        const totalSeats = 24; // 3 ряда по 8 мест
        const freeSeats = totalSeats - bookings.length;

        const li = document.createElement('li');
        li.textContent = `${session.movie} в ${session.time} (${freeSeats} мест свободно)`;
        li.dataset.sessionId = activeSessions.indexOf(session);
        li.addEventListener('click', () => selectSession(activeSessions.indexOf(session)));

        // Подсвечиваем выбранный сеанс
        if (activeSessionIndex === activeSessions.indexOf(session)) li.classList.add('selected');

        ul.appendChild(li);
      }

      dateGroup.appendChild(ul);
      sessionsContainer.appendChild(dateGroup);
    }
  }

  // --- Выбор сеанса ---
  async function selectSession(index) {
    activeSessionIndex = index;
    selectedSeats = [];
    seatsSelectedForBooking = [];
    peopleCount = 1;
    paymentBlock.style.display = 'none';
    updateSessionSelectionUI();
    await loadSeats();
  }

  // --- Обновление UI выбранного сеанса ---
  function updateSessionSelectionUI() {
    document.querySelectorAll('.session-list li').forEach(li => {
      li.classList.toggle('selected', +li.dataset.sessionId === activeSessionIndex);
    });
  }

  // --- Загрузка мест для выбранного сеанса ---
  async function loadSeats() {
    const session = activeSessions[activeSessionIndex];
    if (!session) {
      seatsContainer.style.display = 'none';
      return;
    }

    const bookings = await fetchBookings(session.movie, session.date, session.time);
    const bookedSeats = bookings.map(b => `${b.row}${b.col}`);

    seatsDiv.innerHTML = '';
    seatsContainer.style.display = 'block';

    const rows = ['A', 'B', 'C'];
    const cols = Array.from({length: 8}, (_, i) => i + 1); // 1-8

    selectedSeats = [];
    seatsSelectedForBooking = [];
    peopleCount = 1;
    paymentBlock.style.display = 'none';

    rows.forEach(row => {
      cols.forEach(col => {
        const seatId = `${row}${col}`;
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.textContent = seatId;
        seat.dataset.seatId = seatId;

        if (bookedSeats.includes(seatId)) {
          seat.classList.add('booked');
        } else {
          seat.addEventListener('click', () => onSeatClick(seat));
        }
        seatsDiv.appendChild(seat);
      });
    });
  }

  // --- Обработка клика по месту ---
  function onSeatClick(seat) {
    if (seat.classList.contains('booked')) return;

    // Если уже выбрано места, которые не совпадают с этим (по кол-ву)
    // Чтобы упростить логику, открываем модальное окно для выбора кол-ва человек при каждом клике

    openModal(seat.dataset.seatId);
  }

  // --- Открытие модального окна ---
  function openModal(seatId) {
    modalOverlay.style.display = 'flex';
    peopleCountSelect.value = '1';
    peopleCountSelect.focus();

    // Сохраняем выбранное место для бронирования
    selectedSeats = [seatId];
  }

  // --- Закрытие модального окна ---
  function closeModal() {
    modalOverlay.style.display = 'none';
  }

  // --- Подтверждение выбора количества людей ---
  modalConfirmBtn.addEventListener('click', () => {
    peopleCount = parseInt(peopleCountSelect.value, 10);
    seatsSelectedForBooking = [];

    // Автоматически выбираем места, начиная с выбранного места, вправо по ряду
    // Проверяем, что места свободны
    const firstSeat = selectedSeats[0];
    const row = firstSeat[0];
    const startCol = parseInt(firstSeat.slice(1), 10);
    const seatsElems = Array.from(document.querySelectorAll('.seat:not(.booked)'));

    // Сбрасываем выделение
    seatsElems.forEach(s => s.classList.remove('selected'));

    // Ищем подряд идущие места в ряду
    let foundSeats = [];
    for (let col = startCol; col < startCol + peopleCount; col++) {
      const seatId = row + col;
      const seatElem = seatsElems.find(s => s.dataset.seatId === seatId);
      if (!seatElem) break; // нет такого места
      foundSeats.push(seatElem);
    }

    if (foundSeats.length < peopleCount) {
      alert('Недостаточно свободных соседних мест для выбранного количества человек.');
      closeModal();
      return;
    }

    // Выделяем найденные места
    foundSeats.forEach(s => s.classList.add('selected'));

    // Запоминаем выбранные места
    seatsSelectedForBooking = foundSeats.map(s => s.dataset.seatId);

    // Показываем блок оплаты
    paymentBlock.style.display = 'block';
    paymentBlock.textContent = `Оплата: ${peopleCount} × ${PRICE_PER_SEAT} ₽ = ${peopleCount * PRICE_PER_SEAT} ₽`;

    closeModal();
  });

  // --- Кнопка бронирования ---
  bookBtn.addEventListener('click', async () => {
    if (seatsSelectedForBooking.length === 0 || activeSessionIndex === -1) {
      alert('Выберите места для бронирования!');
      return;
    }

    const session = activeSessions[activeSessionIndex];

    // Формируем данные для бронирования
    const seatsToBook = seatsSelectedForBooking.map(seatId => ({
      type: 'seat',
      row: seatId[0],
      col: parseInt(seatId.slice(1), 10)
    }));

    try {
      const response = await fetch('https://lvgkino.ru/.netlify/functions/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          movie: session.movie,
          date: session.date,
          time: session.time,
          seats: seatsToBook
        })
      });

      if (response.ok) {
        alert('Места успешно забронированы!');
        // Обновляем UI: заново загружаем места и сеансы
        await loadSeats();
        await refreshData();
        paymentBlock.style.display = 'none';
        seatsSelectedForBooking = [];
      } else {
        const error = await response.json();
        alert('Ошибка: ' + (error.message || 'Не удалось забронировать'));
      }
    } catch (err) {
      alert('Ошибка при бронировании. Попробуйте позже.');
      console.error(err);
    }
  });

  // --- Обновление данных ---
  async function refreshData() {
    const prevSessionId = activeSessionIndex;
    let sessions = await fetchSessions();
    sessions = await sortSessions(sessions);
    activeSessions = sessions;

    await drawSessions();

    // Восстанавливаем выбор сеанса, если он ещё существует
    if (prevSessionId !== -1 && activeSessions[prevSessionId]) {
      await selectSession(prevSessionId);
    } else if (activeSessions.length > 0) {
      await selectSession(0);
    } else {
      seatsContainer.style.display = 'none';
    }
  }

  // --- Закрытие модального окна по клику вне ---
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) closeModal();
  });

  // --- Инициализация ---
  window.onload = () => {
    refreshData();
    paymentBlock.style.display = 'none';
  };

  // --- Закрытие модалки по ESC ---
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalOverlay.style.display === 'flex') {
      closeModal();
    }
  });
</script>
</body>
</html>
