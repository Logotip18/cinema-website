<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVG Kino</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1 { color: #333; }
        #session-list { list-style-type: none; padding: 0; }
        #session-list li { padding: 10px; margin: 5px 0; background-color: #fff; border: 1px solid #ddd; cursor: pointer; }
        #session-list li:hover { background-color: #e0e0e0; }
        .selected { background-color: #d0d0d0; font-weight: bold; }
        #seats-container { margin-top: 20px; }
        .seat { display: inline-block; width: 40px; height: 40px; margin: 5px; background-color: #ccc; text-align: center; line-height: 40px; cursor: pointer; }
        .seat.booked { background-color: #ff4d4d; cursor: not-allowed; }
        .seat.selected { background-color: #4CAF50; color: white; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <h1>LVG Kino</h1>

    <h2>Выберите сеанс</h2>
    <ul id="session-list"></ul>

    <div id="seats-container" style="display: none;">
        <h3>Доступные места</h3>
        <div id="seats"></div>
        <button onclick="bookSeats()">Забронировать</button>
    </div>

    <script>
        let activeSessions = [];
        let activeSessionIndex = -1;
        let selectedSeats = [];

        async function fetchSessions() {
            try {
                const response = await fetch('https://lvgkino.ru/.netlify/functions/sessions');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (!Array.isArray(data)) {
                    console.error('Unexpected response format:', data);
                    return [];
                }
                console.log('Fetched sessions:', data);
                return data;
            } catch (error) {
                console.error('Ошибка загрузки сеансов:', error);
                return [];
            }
        }

        async function fetchBookings(movie, date, time) {
            try {
                const response = await fetch(`https://lvgkino.ru/.netlify/functions/bookings?movie=${encodeURIComponent(movie)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const bookings = await response.json();
                console.log('Fetched bookings:', bookings);
                return bookings;
            } catch (error) {
                console.error('Ошибка загрузки бронирований:', error);
                return [];
            }
        }

        function drawSessions() {
            const sessionList = document.getElementById('session-list');
            sessionList.innerHTML = '';
            activeSessions.forEach((session, index) => {
                const li = document.createElement('li');
                li.textContent = `${session.movie} - ${session.date} в ${session.time} (ID: ${session.id})`;
                li.addEventListener('click', () => selectSession(index));
                sessionList.appendChild(li);
            });
        }

        async function selectSession(index) {
            activeSessionIndex = index;
            document.querySelectorAll('#session-list li').forEach((li, i) => {
                li.classList.toggle('selected', i === index);
            });
            await loadSeats();
        }

        async function loadSeats() {
            const session = activeSessions[activeSessionIndex];
            if (!session) return;
            const bookings = await fetchBookings(session.movie, session.date, session.time);
            const seatsContainer = document.getElementById('seats-container');
            const seatsDiv = document.getElementById('seats');
            seatsDiv.innerHTML = '';
            seatsContainer.style.display = 'block';

            // Пример сетки мест (3 ряда, 5 колонок)
            const rows = ['A', 'B', 'C'];
            const cols = [1, 2, 3, 4, 5];
            const bookedSeats = bookings.map(b => `${b.row}${b.col}`);

            rows.forEach(row => {
                cols.forEach(col => {
                    const seatId = `${row}${col}`;
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.textContent = seatId;
                    if (bookedSeats.includes(seatId)) {
                        seat.classList.add('booked');
                    } else {
                        seat.addEventListener('click', () => toggleSeat(seatId));
                    }
                    seatsDiv.appendChild(seat);
                });
            });
        }

        function toggleSeat(seatId) {
            const seat = document.querySelector(`.seat:contains(${seatId})`);
            if (seat && !seat.classList.contains('booked')) {
                const isSelected = seat.classList.toggle('selected');
                if (isSelected) {
                    selectedSeats.push({ type: 'seat', row: seatId[0], col: parseInt(seatId.slice(1)) });
                } else {
                    selectedSeats = selectedSeats.filter(s => `${s.row}${s.col}` !== seatId);
                }
            }
        }

        async function bookSeats() {
            if (selectedSeats.length === 0 || activeSessionIndex === -1) {
                alert('Выберите места для бронирования!');
                return;
            }
            const session = activeSessions[activeSessionIndex];
            const response = await fetch('https://lvgkino.ru/.netlify/functions/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    movie: session.movie,
                    date: session.date,
                    time: session.time,
                    seats: selectedSeats
                })
            });

            if (response.ok) {
                alert('Места успешно забронированы!');
                selectedSeats = [];
                await loadSeats();
            } else {
                const error = await response.json();
                alert('Ошибка: ' + (error.message || 'Не удалось забронировать'));
            }
        }

        // Автоматическая загрузка сеансов каждые 5 секунд для синхронизации
        async function refreshData() {
            activeSessions = await fetchSessions();
            drawSessions();
            if (activeSessionIndex !== -1) await loadSeats();
        }

        setInterval(refreshData, 5000);

        // Инициализация при загрузке страницы
        window.onload = () => {
            refreshData();
        };
    </script>
</body>
</html>